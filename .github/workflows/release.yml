name: Release Desktop

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须

    steps:
      # ------------------------------
      # 1. Get run ID of Build Desktop workflow
      # ------------------------------
      - name: Get latest Build Desktop run ID
        run: |
          gh auth setup-git
          RUN_ID=$(gh run list -w "Build Desktop" -L 1 --json databaseId -q ".[0].databaseId")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # ------------------------------
      # 2. Download all artifacts
      # ------------------------------
      - name: Download artifacts from latest Build
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "Build Desktop"
          run_id: ${{ env.RUN_ID }}
          path: artifacts

      - name: List downloaded files
        run: ls -R artifacts

      # ------------------------------
      # 3. Create Github Release
      # ------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          draft: true
          prerelease: false
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
