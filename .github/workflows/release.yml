name: Release Desktop

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true

jobs:
  release-artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须

    steps:
      # ------------------------------
      # 1. Get run ID of Build Desktop workflow
      # ------------------------------
      - name: Get latest Build Desktop run ID
        id: get-run-id
        run: |
          RUN_ID=$(gh run list \
          --repo "$GITHUB_REPOSITORY" \
          --workflow="Build Desktop" \
          --status=success \
          --limit=1 \
          --json databaseId \
          --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "错误: 未找到成功的 Build Desktop 工作流运行"
            exit 1
          fi

          echo "找到运行ID: $RUN_ID"
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------
      # 2. Download all artifacts
      # ------------------------------
      - name: Download artifacts from latest Build
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "Build Desktop"
          run_id: ${{ env.RUN_ID }}
          path: artifacts
          skip_unpack: true

      - name: List downloaded files
        run: |
          echo "已下载的构件:"
          find artifacts -type f | sort

      # ------------------------------
      # 3. Create Github Release
      # ------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          draft: true
          prerelease: false
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.exe
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-draft:
    needs: release-artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Release Drafter
        uses: release-drafter/release-drafter@v6.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
