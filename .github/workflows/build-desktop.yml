name: Build Desktop

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Choose target platforms'
        required: false
        default: '["ubuntu-latest","macos-latest","windows-latest"]'
        type: choice
        options:
          - '["ubuntu-latest","macos-latest","windows-latest"]'
          - '["ubuntu-latest"]'
          - '["macos-latest"]'
          - '["windows-latest"]'
          - '["ubuntu-latest","windows-latest"]'
          - '["macos-latest","windows-latest"]'

jobs:

  # ------------------------
  # 1. Build backend per OS
  # ------------------------
  backend:
    strategy:
      matrix:
        os: ${{ fromJSON(github.event.inputs.platforms) }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Prepare env files
        run: |
          cp backend/.env.example backend/.env
          cp frontend/env/.env.example frontend/env/.env

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Build backend
        shell: bash
        run: |
          cd backend
          python -m venv .venv

          if [ -f ".venv/bin/python" ]; then
            VENV_PY=".venv/bin/python"
          else
            VENV_PY=".venv/Scripts/python.exe"
          fi

          $VENV_PY -m pip install uv
          $VENV_PY -m uv sync
          $VENV_PY -m uv add --dev pyinstaller
          $VENV_PY -m uv run pyinstaller --noconfirm runnable.spec

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.os }}
          path: backend/dist/runnable
          include-hidden-files: true

  # ------------------------
  # 2. Build frontend Electron
  # ------------------------
  frontend:
    needs: backend
    strategy:
      matrix:
        os: ${{ fromJSON(github.event.inputs.platforms) }}
    runs-on: ${{ matrix.os }}

    env:
      # Used for sign
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      CSC_IDENTITY_AUTO_DISCOVERY: true

    steps:
      - uses: actions/checkout@v4

      - name: Prepare env files
        run: |
          cp backend/.env.example backend/.env
          cp frontend/env/.env.example frontend/env/.env

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.os }}
          path: backend/dist/runnable

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd frontend
          yarn install

      # ===============================
      # ⭐ macOS code sign: Import Developer ID
      # ===============================
      - name: Import macOS signing certificate
        if: runner.os == 'macOS'
        env:
          MAC_CERT_P12: ${{ secrets.MAC_CERT_P12 }}
          MAC_CERT_PASSWORD: ${{ secrets.MAC_CERT_PASSWORD }}
        run: |
          echo "$MAC_CERT_P12" | base64 --decode > certificate.p12

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          security import certificate.p12 \
            -k build.keychain \
            -P "$MAC_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "" build.keychain

          security find-identity -v -p codesigning

      - name: Set macOS signing environment variables
        if: runner.os == 'macOS'
        run: |
          export CSC_LINK=certificate.p12
          export CSC_KEY_PASSWORD=${{ secrets.MAC_CERT_PASSWORD }}
          export CSC_IDENTITY_AUTO_DISCOVERY=true
          export APPLE_ID=${{ secrets.APPLE_ID }}
          export APPLE_PASSWORD=${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          export APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}

      - name: Fix Python Framework Structure
        if: runner.os == 'macOS'
        run: |
          FRAMEWORK_PATH="frontend/dist/electron/Packaged/mac-arm64/PileaX.app/Contents/Resources/backend/_internal/Python.framework"

          # 进入框架目录
          cd "$FRAMEWORK_PATH"

          # 如果 Python 是个普通文件而不是链接，修复它
          if [ -f "Python" ] && [ ! -L "Python" ]; then
            echo "Fixing broken Python symlink..."
            rm Python
            ln -s Versions/Current/Python Python
          fi

          # 同样检查 Resources
          if [ -d "Resources" ] && [ ! -L "Resources" ]; then
            echo "Fixing broken Resources symlink..."
            rm -rf Resources
            ln -s Versions/Current/Resources Resources
          fi

      - name: Pre-sign Python Backend
        if: runner.os == 'macOS'
        run: |
          IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -n 1 | awk -F '"' '{print $2}')
          echo "Using Identity: $IDENTITY"

          codesign --force --options runtime --timestamp --deep --sign "$IDENTITY" --keychain build.keychain backend/dist/runnable

      # ===============================
      # Build Electron (Auto sign)
      # ===============================
      - name: Build Electron app
        shell: bash
        run: |
          if [[ "$RUNNER_OS" != "Windows_NT" ]]; then
            chmod +x backend/dist/runnable/runnable
          fi

          cd frontend
          node_modules/.bin/electron-rebuild
          yarn build:electron

      - name: Upload Electron build
        uses: actions/upload-artifact@v4
        with:
          name: pileax-${{ matrix.os }}
          path: |
            frontend/dist/electron/Packaged/*.dmg
            frontend/dist/electron/Packaged/*.exe
            frontend/dist/electron/Packaged/*.AppImage
          if-no-files-found: ignore
